    # Healthsta.be legacy domains go here once they are migrated to the new platform this will be removed
    # BW 2024-10-02
upstream hdintegrationproxy {
  server 10.72.128.46:8080;
}

server {
  listen *:80;
  listen [::]:80;

  server_name hd4dp.dmz.it.com www.hd4dp.dmz.it.com rprox.dmz.it.com rproxacc.dmz.it.com;

  return 301 https://$server_name$request_uri;
}

upstream sonatype_healthdata {
       # server 10.72.128.83; not working using proxy_pass sonatype_healthdata;
   server 10.72.128.83;
   }

server {
  listen 80;
  listen [::]:80;

  server_name hd4dp.be www.hd4dp.be;
  return 301 https://hd4dp.dmz.it.com$request_uri;
}

proxy_cache_path /opt/nginx/prod_cache levels=1:2 keys_zone=prod_cache:10m inactive=24h;

server {
  listen *:443 ssl;
  listen [::]:443 ssl;
  server_name hd4dp.dmz.it.com www.hd4dp.dmz.it.com;

        # access_log /var/log/nginx/access.log;
        # error_log  /var/log/nginx/error.log;

  ssl_protocols TLSv1.2 TLSv1.3;
  include /opt/nginx/conf.d/includes/https_proxyssl_origins.conf;
  include /opt/nginx/conf.d/includes/https_dmz.conf;

  # ssl_certificate /etc/ssl/certs/star_healthdata_be.bundle;
  # ssl_certificate_key /etc/ssl/private/star_healthdata_be.key;

  error_page 480 /error.html;

  location /proxy/swagger-ui {
  allow  10.2.108.0/24;
  allow  10.2.105.0/24;
  deny   all;
  return 403 "Access Denied";
  }

  location  /api/externalreference/consultrn/searchPersonBySsin {
  return 403 "Access Denied";
  }

  location / {
    if ($http_user_agent ~ MSIE) {
      return 480;
    }

    if ($http_user_agent ~ 'rv:11') {
      return 480;
    }

    proxy_pass https://10.72.128.47/;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
    proxy_set_header X-Forwarded-Proto $scheme;

  }

  location /error.html {
    root /var/www/html/healthdata/error;
  }

}

# catalogue-acc.dmz.it.com BEGIN

    server {
        listen *:80;
        listen *:443;
        # access_log /var/log/nginx/access.log;
        # error_log  /var/log/nginx/error.log;

        server_name catalogue-acc.dmz.it.com;
        error_page    500 502 503 504  /50x.html;
        include /opt/nginx/conf.d/includes/https_proxyssl_origins.conf;
        include /opt/nginx/conf.d/includes/https_dmz.conf;
        location / {
             client_max_body_size 4g;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header Host $host;
            proxy_pass http://10.72.129.67:8080;
        }
    }
# catalogue-acc.dmz.it.com END

# Nexus Sonatype BEGIN
    server {
        listen *:80;
        listen *:443;
        access_log /var/log/nginx/access.log;
        error_log  /var/log/nginx/error.log;
          access_log  off;
        error_log off;

        server_name sonatype.dmz.it.com;
        error_page    500 502 503 504  /50x.html;
        include /opt/nginx/conf.d/includes/https_proxyssl_origins.conf;
        include /opt/nginx/conf.d/includes/https_dmz.conf;
        location / {
             client_max_body_size 4g;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header Host $host;
            proxy_pass https://10.72.128.83;
            #proxy_redirect      http://localhost:8090 https://jenkins.domain.com;
        }
    }
# Nexus Sonatype END


    server {
        listen *:80;
        listen *:443;
        access_log  off;
        error_log off;
        server_name registrypush.dmz.it.com;
        error_page    500 502 503 504  /50x.html;
        include /opt/nginx/conf.d/includes/https_proxyssl_origins.conf;
        include /opt/nginx/conf.d/includes/https_dmz.conf;
        location / {
        client_max_body_size 4g;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header Host $host;
            proxy_pass https://10.72.128.45;
            #proxy_redirect      http://localhost:8090 https://jenkins.domain.com;
        }
    }

# Nexus Registry BEGIN
    server {
        listen *:80;
        listen *:443;
        access_log  off;
        error_log off;
        server_name 192.168.1.193:30082;
        proxy_read_timeout 300s;
        proxy_connect_timeout 120s;
        proxy_send_timeout 900s;
        proxy_buffering off;
        error_page    500 502 503 504  /50x.html;
        include /opt/nginx/conf.d/includes/https_proxyssl_origins.conf;
        include /opt/nginx/conf.d/includes/https_dmz.conf;
        location / {
        client_max_body_size 4g;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header Host nexus.dmz.it.com;
#            proxy_set_header Host sonatype.dmz.it.com; # migrating to new nexus comment this out and comment above line
#proxy_pass https://10.72.128.45;
            proxy_pass https://10.72.128.83; # migrating to new nexus comment this out and comment above line
            #proxy_redirect      http://localhost:8090 https://jenkins.domain.com;
        }
    }
# Nexus Registry END

# Nexus Registry BEGIN
    server {
        listen *:80;
        listen *:443;
        server_name nexus.dmz.it.com;
        access_log  off;
        error_log off;
        error_page    500 502 503 504  /50x.html;
        include /opt/nginx/conf.d/includes/https_proxyssl_origins.conf;
        include /opt/nginx/conf.d/includes/https_dmz.conf;
        location / {
            client_max_body_size 4g;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header Host $host;
#            proxy_set_header Host sonatype.dmz.it.com; # migrating to new nexus comment this out and comment above line
#proxy_pass https://10.72.128.45;
            proxy_pass https://10.72.128.83; # migrating to new nexus comment this out and comment above line
            #proxy_redirect      http://localhost:8090 https://jenkins.domain.com;
        }
    }
# Nexus Registry END

# Nexus RPROX BEGIN

server {
  listen 8080 ssl;
  listen [::]:8080 ssl;

  server_name rprox.dmz.it.com, rproxacc.dmz.it.com;

  ssl_protocols TLSv1.2 TLSv1.3;
        include /opt/nginx/conf.d/includes/https_proxyssl_origins.conf;
        include /opt/nginx/conf.d/includes/https_dmz.conf;

  # ssl_certificate /etc/ssl/certs/star_healthdata_be.bundle;
  # ssl_certificate_key /etc/ssl/private/star_healthdata_be.key;

#  auth_basic "Administratorâ€™s Area";
#  auth_basic_user_file /etc/nginx/.htpasswd;

  location / {
    proxy_pass http://10.72.128.45:1234/;
  }
}



server {
  listen 443 ssl;
  listen [::]:443 ssl;
  port_in_redirect on;
  server_name rprox.dmz.it.com;
        include /opt/nginx/conf.d/includes/https_proxyssl_origins.conf;
        include /opt/nginx/conf.d/includes/https_dmz.conf;

  # ssl_protocols TLSv1.2 TLSv1.3;

  # ssl_certificate /etc/ssl/certs/star_healthdata_be.bundle;
  # ssl_certificate_key /etc/ssl/private/star_healthdata_be.key;
        access_log  off;
        error_log off;

  #location /actuator/health {
  #     return 200;
  #}

  location / {
    proxy_pass http://hdintegrationproxy;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    #set $proxy_pass_backend  "10.72.128.46:8080";

    #if ($http_s3_bucket !~ "authorgroups" ) {
    #     set $proxy_pass_backend "10.72.128.5:9000";
    #}
    #proxy_pass http://$proxy_pass_backend;
    #proxy_set_header Host $http_host;
    #proxy_set_header X-Real-IP $remote_addr;
    #proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #proxy_set_header X-Forwarded-Proto $scheme;

  }

  location /api/installation/extended-info {
    #expires 1m;
    proxy_pass http://10.72.128.46:8080;
    #proxy_ignore_headers "Set-Cookie" "Cache-Control" "Expires";
    #proxy_hide_header "Set-Cookie";
    #proxy_hide_header "Cache-Control";
    #proxy_set_header Host $host;
    #proxy_buffering off;
    #proxy_cache prod_cache;
    #proxy_cache_valid 200 10m;
    #proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504 http_429;
    #proxy_cache_lock on;
    #add_header X-Cached $upstream_cache_status;
  }

  location /api/installation/participation {
    #expires 1m;
    proxy_pass http://10.72.128.46:8080;
    #proxy_ignore_headers "Set-Cookie" "Cache-Control" "Expires";
    #proxy_hide_header "Set-Cookie";
    #proxy_hide_header "Cache-Control";
    #proxy_set_header Host $host;
    #proxy_buffering on;
    #proxy_cache prod_cache;
    #proxy_cache_valid 200 10m;
    #proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504 http_429;
    #proxy_cache_lock on;
    #add_header X-Cached $upstream_cache_status;
  }

  # location /dynatrace_agent {
  #   proxy_pass https://lkq63483.live.dynatrace.com/api/v1/deployment/installer/agent/unix/default/latest?arch=x86&flavor=default;
  # }

  # location /dynatrace-root.cert.pem {
  #   proxy_pass https://ca.dynatrace.com/dt-root.cert.pem;
  # }

  location /monitoring/ {
    #return 403;
    if ($http_user_agent !~ "v89TiJbVQUweaa7Bb3tFtW2KQdGb" ) {
      return 403;
    }
    proxy_pass http://10.72.128.55:8086/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }
  location /write/ {
    #return 403;
    if ($http_user_agent !~ "v89TiJbVQUweaa7Bb3tFtW2KQdGb" ) {
      return 403;
    }
    proxy_pass http://10.72.128.55:8086/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }
  location /s3/ {
    rewrite ^/s3/(.*) /$1 break;
    proxy_pass http://10.72.128.5:9000;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  location /authorgroups/ {
    proxy_pass http://10.72.128.5:9000;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

}

proxy_cache_path /data/nginx/cache levels=1:2 keys_zone=acceptance_cache:10m inactive=24h;

map $request_method $purge_method {
   PURGE   1;
   default 0;
}
# Nexus RPROX END

# Nexus RPROX ACC BEGIN


server {
  listen 443 ssl;
  listen [::]:443 ssl;
  server_name rproxacc.dmz.it.com;
        access_log  off;
        error_log off;
        include /opt/nginx/conf.d/includes/https_proxyssl_origins.conf;
        include /opt/nginx/conf.d/includes/https_dmz.conf;

  # ssl_protocols TLSv1.2 TLSv1.3;

  # ssl_certificate /etc/ssl/certs/star_healthdata_be.bundle;
  # ssl_certificate_key /etc/ssl/private/star_healthdata_be.key;

  location / {
    proxy_pass http://10.72.130.163:8080/;
    proxy_read_timeout 120s;
    proxy_connect_timeout 120s;
    proxy_send_timeout 120s;
  }

  location /actuator/health {
        return 200;
  }

  location /api/installation/extended-info {
    #expires 1m;
    proxy_pass http://10.72.130.163:8080;
    #proxy_ignore_headers "Set-Cookie" "Cache-Control" "Expires";
    #proxy_hide_header "Set-Cookie";
    #proxy_hide_header "Cache-Control";
    #proxy_set_header Host $host;
    #proxy_buffering on;
    #proxy_cache acceptance_cache;
    #proxy_cache_valid 200 10m;
    #proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504 http_429;
    #proxy_cache_lock on;
    #add_header X-Cached $upstream_cache_status;
  }

  location /api/installation/participation {
    #expires 1m;
    proxy_pass http://10.72.130.163:8080;
    #proxy_ignore_headers "Set-Cookie" "Cache-Control" "Expires";
    #proxy_hide_header "Set-Cookie";
    #proxy_hide_header "Cache-Control";
    #proxy_set_header Host $host;
    #proxy_buffering on;
    #proxy_cache acceptance_cache;
    #proxy_cache_valid 200 10m;
    #proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504 http_429;
    #proxy_cache_lock on;
  }
}

# Redirect service to service-now support page
server {
  listen *:80;
  listen [::]:80;
  server_name support.dmz.it.com;
          access_log  off;
        error_log off;
        access_log /var/log/nginx/access.log main;
        error_log  /var/log/nginx/error.log;

  return 301 https://sciensano.service-now.com/sp;
}

server {
  listen *:443;
  listen [::]:443;
        access_log  off;
        error_log off;
  server_name support.dmz.it.com;
            access_log /var/log/nginx/access.log main;
        error_log  /var/log/nginx/error.log;

        include /opt/nginx/conf.d/includes/https_proxyssl_origins.conf;
        include /opt/nginx/conf.d/includes/https_dmz.conf;

  # ssl_protocols TLSv1.2 TLSv1.3;
  # ssl_certificate /etc/ssl/certs/star_healthdata_be.bundle;
  # ssl_certificate_key /etc/ssl/private/star_healthdata_be.key;
  return 301 https://sciensano.service-now.com/sp;
}
# Nexus RPROX ACC END

# Nexus LEGACY RPROX DOCKER REGISTRY BEGIN (BW 2024-10-02)

server {
  listen 18080 ssl;
  listen [::]:18080 ssl;
        access_log  off;
        error_log off;

  server_name rproxacc.dmz.it.com rprox.dmz.it.com;
        include /opt/nginx/conf.d/includes/https_proxyssl_origins.conf;
        include /opt/nginx/conf.d/includes/https_dmz.conf;

  # ssl_protocols TLSv1.2 TLSv1.3;

  # ssl_certificate /etc/ssl/certs/star_healthdata_be.bundle;
  # ssl_certificate_key /etc/ssl/private/star_healthdata_be.key;

  location /hddockerscript/ {
    if ($http_user_agent !~ "J87PsHbaKAgTmhsWbnnn9XnTkzHH" ) {
      return 403;
    }
    proxy_pass http://10.72.128.45:8080/repository/hd-files/dockerinstaller/prod/hd-installer.deb;
    proxy_set_header Host nexus.dmz.it.com;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  location /{
    if ($http_user_agent !~ "(docker|containerd)" ) {
      return 404;
    }
    proxy_pass https://10.72.128.83; # migrating to new nexus comment this out and comment above line
    #proxy_pass http://10.72.128.45:18080/;
    #proxy_pass https://10.72.128.45; trying to use https on standard port BW 2024-10-02
    

    proxy_set_header Host nexus.dmz.it.com;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }
}

# Nexus LEGACY RPROX DOCKER REGISTRY END (BW 2024-10-02)


# HD4RES ARCH 1 (BW 2024-10-17) BEGIN
server {
  listen *:80;
  listen [::]:80;
  server_name hd4res-acc.dmz.it.com;
  return 301 https://hd4res-acc.dmz.it.com;
}

server {
  listen *:443;
  listen [::]:443;
  server_name hd4res-acc.dmz.it.com;
        include /opt/nginx/conf.d/includes/https_proxyssl_origins.conf;
        include /opt/nginx/conf.d/includes/https_dmz.conf;

  location / {
      proxy_pass http://10.72.129.66/;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Port $server_port;
      proxy_set_header X-Forwarded-Proto $scheme;
  }

}
# HD4RES ARCH 1 (BW 2024-10-17) END

	    upstream minio_cluster_azure_aks_prod {
      server 10.33.140.250:443;
    }
	    upstream minio_cluster_web {
      server 10.72.131.6:9001;
    }

    upstream minio_cluster_cli {
      server 10.72.131.6:9000;
    }

    upstream minio_cluster_cli_node6
    {
          server 10.72.131.6:9000;
    }

    upstream minio_cluster_cli_node7
    {
          server 10.72.131.7:9000;
    }



# New Production Minio S3 in Kubernetes (BW 2025-02-15) BEGIN
  server {
      # listen *:9080;
      # listen *:9443 ssl;
      listen *:80;
      listen *:443 ssl;
  server_name s3.dmz.it.com;

  ssl_protocols TLSv1.2 TLSv1.3;
  include /opt/nginx/conf.d/includes/https_proxyssl_origins.conf;
  include /opt/nginx/conf.d/includes/https_dmz.conf;

  location / {
            proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header Host $http_host;

  proxy_connect_timeout 300;
  # Default is HTTP/1, keepalive is only enabled in HTTP/1.1
  proxy_http_version 1.1;
#  proxy_set_header Connection "";
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";

  chunked_transfer_encoding off;

  proxy_pass https://minio_cluster_azure_aks_prod;
      }
  }
# New Production Minio S3 in Kubernetes (BW 2025-02-15) END


# Minio S3 (BW 2024-11-06) BEGIN
  server {
      # listen *:9080;
      # listen *:9443 ssl;
      listen *:80;
      listen *:443 ssl;
  server_name s3.kubes.dmz.it.com;

  include /opt/nginx/conf.d/includes/https_dmz.conf;

  location / {
            proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header Host $http_host;

  proxy_connect_timeout 300;
  # Default is HTTP/1, keepalive is only enabled in HTTP/1.1
  proxy_http_version 1.1;
#  proxy_set_header Connection "";
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";

  chunked_transfer_encoding off;

  proxy_pass http://minio_cluster_web;
      }
  }

# Minio cluster cli
server {
        # listen *:9080;
        # listen *:9443 ssl;
        listen *:80;
        listen *:443 ssl;

  server_name s3-cli.kubes.dmz.it.com;

  client_max_body_size 500M;

  include /opt/nginx/conf.d/includes/https_dmz.conf;

  location / {
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Host $http_host;

    proxy_connect_timeout 300;
    # Default is HTTP/1, keepalive is only enabled in HTTP/1.1
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    #   proxy_set_header Connection "";
    proxy_set_header Connection "upgrade";
    chunked_transfer_encoding off;
    proxy_pass http://minio_cluster_cli;
  }
}
# Minio S3 (BW 2024-11-06) END
