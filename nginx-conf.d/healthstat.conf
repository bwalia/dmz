    # Healthsta.be legacy domains go here once they are migrated to the new platform this will be removed
    # BW 2019-09-10

        upstream azure_lb_upstream {
       server 10.33.140.250:80;
   }

    upstream azure_lb_https_upstream {
       server 10.33.140.250:443;
   }

    upstream lb_https_upstream {

        server 10.72.131.10:443;
        #server 10.72.131.20:443;  #backup;

    }

upstream azure_acc_lb_http_upstream {

        server 10.33.139.250:80;
        #server 10.72.131.20:80;  #backup;

}

    upstream azure_acc_lb_https_upstream {

        server 10.33.139.250:443;
        #server 10.72.131.20:443;  #backup;

    }

    upstream azure_test_sso_lb_https_upstream {

        server 10.33.144.10:8443;
        #server 10.72.131.20:443;  #backup;

    }

    upstream azure_acc_sso_lb_https_upstream {

        server 10.33.144.74:8443;
        server 10.33.144.75:8443;
        #server 10.72.131.20:443;  #backup;

    }

    upstream lb_http_upstream {

        server 10.72.131.10:80;
        #server 10.72.131.20:80;  #backup;

    }

    upstream k3s_api_servers {
      server 10.72.131.1:6443;
    }


    upstream azure_lb_http_upstream {
	server 10.33.139.100:80;
        #server 10.33.136.143:80;

    }

    upstream azurehsaks_lb_https_upstream {
        server 10.33.139.100:443;
        #server 10.33.136.143:80;

    }

    upstream k3s_workers_http_upstream {

        server 10.72.131.4:30660;
        server 10.72.131.5:30660;
        server 10.72.131.6:30660;
        server 10.72.131.7:30660;

    }

    upstream k3s_workers_https_upstream {

        server 10.72.131.4:31250;
        server 10.72.131.5:31250;
        server 10.72.131.6:31250;
        server 10.72.131.7:31250;

    }

    #  nexus ip is 10.72.128.45 but set in the vars file
    upstream docker_registry_nexus_ip {
      server 10.72.128.45:18080;
    }


    #include       /etc/nginx/mime.types;
    #default_type  application/octet-stream;

    # This log format is used for the all domains so moved to the root nginx conf file
    # log_format  main  '$remote_addr $host - $remote_user [$time_local] "$request" '
    #                   '$status $body_bytes_sent "$http_referer" '
    #                   '"$http_user_agent" "$http_x_forwarded_for"' '"$host"' '"$http_host"';

    # access_log  /var/log/nginx/access.log  main;
    client_max_body_size 50M;

    #sendfile        on;
    #tcp_nopush     on;

    #keepalive_timeout  65;

    #gzip  on;


    server_tokens off;
    charset       utf-8;

    # access_log    logs/access.log  combined;
    
# Docker registry url domains
    server {
    listen *:80;
    listen *:443 ssl;
    server_name registry.kubes.healthdata.be;

	location / {
return 301 https://nexus.healthdata.be;
}

    include /opt/nginx/conf.d/includes/https_healthdata.conf;

    location /____zzz_____ {
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Host $http_host;

        proxy_connect_timeout 300;
        # Default is HTTP/1, keepalive is only enabled in HTTP/1.1
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        chunked_transfer_encoding off;
        client_max_body_size 4g;
        proxy_pass http://docker_registry_nexus_ip;
    }
}

    upstream bpa_backends {
        server 10.72.131.10;
        #server 10.72.131.20:9943;  #backup;
    }

    upstream bpa_formiofrontends {
        server 10.72.131.10;
        #server 10.72.131.20:9943;  #backup;
    }

    upstream bpa_backends_https {
        server 10.72.131.10;
        #server 10.72.131.20:9943;  #backup;
    }

    upstream bpa_formiofrontends_https {
        server 10.72.131.10;
        #server 10.72.131.20:9943;  #backup;
    }

    server {
        listen *:80;
        listen *:443 ssl;
        server_name *.kubes.healthdata.be;
        #dev.kubes.healthdata.be hd4dp-dev.kubes.healthdata.be hd4dp-test.kubes.healthdata.be test.kubes.healthdata.be hd4dp-acc.kubes.healthdata.be acc.kubes.healthdata.be;

        include /opt/nginx/conf.d/includes/https_healthdata.conf;

        location / {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $host;
        proxy_pass http://bpa_formiofrontends;
        }
    }

    upstream bpa_iatdev_formiobackend {
        server 10.72.131.10;
        #server 10.72.131.20:9943;  #backup;
    }

    server {
        listen *:80;
        listen *:443 ssl;
        server_name formio-iatdev.kubes.healthdata.be;

        include /opt/nginx/conf.d/includes/https_healthdata.conf;

        location /proxy/api/ {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host api-iatdev.kubes.healthdata.be;
        proxy_pass http://bpa_api;
        rewrite ^/proxy/(.*)$ /$1 break;
        }

        location / {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $host;
        proxy_pass http://bpa_formiobackend;
        }

    }


    server {
        listen *:80;
        listen *:443 ssl;
        server_name formio-dev.kubes.healthdata.be;

        include /opt/nginx/conf.d/includes/https_healthdata.conf;

        location /proxy/api/ {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host api-dev.kubes.healthdata.be;
        proxy_pass http://bpa_api;
        rewrite ^/proxy/(.*)$ /$1 break;
        }

        location / {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $host;
        proxy_pass http://bpa_formiobackend;
        }

    }


    upstream bpa_formiobackend {
        server 10.72.131.10;
        #server 10.72.131.20:9943;  #backup;
    }

    server {
        listen *:80;
        listen *:443 ssl;

        server_name formio-test.kubes.healthdata.be formio-acc.kubes.healthdata.be formio-uat.kubes.healthdata.be formio-int.kubes.healthdata.be formio-dcdev.kubes.healthdata.be;
        include /opt/nginx/conf.d/includes/https_healthdata.conf;

        location / {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $host;
        proxy_pass http://bpa_formiobackend;
        }
    }
      upstream bpa_dp-nextgen {
        server 10.72.131.10:9994;
        server 10.72.131.20:9994;  #backup;
    }

    server {
        listen *:80;
        listen *:443 ssl;
        server_name  dp-nextgen-test.kubes.healthdata.be dp-nextgen-acc.kubes.healthdata.be dp-nextgen-uat.kubes.healthdata.be;

        include /opt/nginx/conf.d/includes/https_healthdata.conf;

        location / {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $host;
        proxy_ssl_verify off;
        proxy_pass https://bpa_dp-nextgen;
        }
    }


      upstream bpa_hd-nextgen {
        server 10.72.131.10:9994;
        server 10.72.131.20:9994;  #backup;
    }

    server {
        listen *:80;
        listen *:443 ssl;
        server_name hd-nextgen-test.kubes.healthdata.be hd-nextgen-acc.kubes.healthdata.be hd-nextgen-uat.kubes.healthdata.be;

        include /opt/nginx/conf.d/includes/https_healthdata.conf;

        location / {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $host;
        proxy_ssl_verify off;
        proxy_pass https://bpa_hd-nextgen;
        }
    }


      upstream bpa_api {
        server 10.72.131.10;
        #server 10.72.131.20:9943;  #backup;
    }

    server {
        listen *:80;
        #listen *:443 ssl;
        server_name api-dev.kubes.healthdata.be api-test.kubes.healthdata.be api-acc.kubes.healthdata.be api-uat.kubes.healthdata.be api-iatdev.kubes.healthdata.be;

        include /opt/nginx/conf.d/includes/https_healthdata.conf;

        location / {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $host;
        proxy_pass http://bpa_api;
        }
    }


      upstream bpa_cloudbeaver {
        server 10.72.131.10;
        #server 10.72.131.20:9943;  #backup;
    }

    server {
        listen *:80;
        listen *:443 ssl;
        server_name cloudb-test.kubes.healthdata.be cloudb-acc.kubes.healthdata.be cloudb-uat.kubes.healthdata.be;

        include /opt/nginx/conf.d/includes/https_healthdata.conf;

        location / {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $host;
        proxy_pass http://bpa_cloudbeaver;
        }
    }

   server {
       listen *:80;
       listen *:443 ssl;
       server_name hello.kubes.healthdata.be;

       error_page    500 502 503 504  /50x.html;
       # include includes/https_generic_proxyssl_client.conf;
       location / {
       default_type text/plain;

         # return 200 "hello.kubes.healthdata is working ok nginx pair";

         proxy_ssl_protocols           TLSv1 TLSv1.1 TLSv1.2;
         proxy_ssl_ciphers             HIGH:!aNULL:!MD5;
         proxy_ssl_verify        off;
         proxy_ssl_verify_depth  2;
         proxy_ssl_session_reuse on;
         proxy_set_header Host $host;
         proxy_set_header X-Real-IP $remote_addr;

          proxy_pass https://lb_https_upstream;
          }
   }
    # API Gateway Backdoor and Frontdoor services
   server {
       listen *:80;
       server_name dmz.dev.kubes.healthdata.be;

       error_page    500 502 503 504  /50x.html;
       location / {
       default_type text/plain;

         proxy_ssl_protocols           TLSv1 TLSv1.1 TLSv1.2;
         proxy_ssl_ciphers             HIGH:!aNULL:!MD5;
         proxy_ssl_verify        off;
         proxy_ssl_verify_depth  2;
         proxy_ssl_session_reuse on;
         proxy_set_header Host $host;
         proxy_set_header X-Real-IP $remote_addr;

          proxy_pass http://10.72.131.1:30393;
          }
   }

   server {
       listen *:80;
       server_name test-frontdoor.kubes.healthdata.be acc-frontdoor.kubes.healthdata.be uat-frontdoor.kubes.healthdata.be frontdoor.kubes.healthdata.be acc-apigw.kubes.healthdata.be uat-apigw.kubes.healthdata.be apigw.kubes.healthdata.be;

       error_page    500 502 503 504  /50x.html;
       location / {
       default_type text/plain;

         proxy_ssl_protocols           TLSv1 TLSv1.1 TLSv1.2;
         proxy_ssl_ciphers             HIGH:!aNULL:!MD5;
         proxy_ssl_verify        off;
         proxy_ssl_verify_depth  2;
         proxy_ssl_session_reuse on;
         proxy_set_header Host $host;
         proxy_set_header X-Real-IP $remote_addr;

#          proxy_pass https://lb_https_upstream;
proxy_pass http://localhost:8080;
          }
   }
    # API Gateway Backdoor and Frontdoor services

    server {
        listen *:80;
        listen *:443 ssl;
        server_name k3s-cluster-1.kubes.healthdata.be;
        include /opt/nginx/conf.d/includes/https_healthdata.conf;

        location / {
        default_type text/plain;

          # return 200 "k3s-cluster-1.kubes.healthdata.be is working ok node 1";

          # include includes/https_generic_proxyssl_client.conf;

          proxy_pass https://k3s_api_servers;
          }
    }

      upstream bpa_superset {
        server 10.72.131.10;
        #server 10.72.131.20:9943;  #backup;
    }

    server {
        listen *:80;
        listen *:443 ssl;
        server_name superset-test.kubes.healthdata.be superset-acc.kubes.healthdata.be superset-uat.kubes.healthdata.be ;
        include /opt/nginx/conf.d/includes/https_healthdata.conf;
        location / {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $host;
        proxy_pass http://bpa_superset;
        }
    }

# 1st Nov 2023 18:41:00 BST added BW
# Healthstat v3 domains BEGIN

    server {
        listen        *:80;
        server_name acc-v3.healthstat.be;

        error_page    500 502 503 504  /50x.html;
        location / {
        #proxy_pass http://lb_http_upstream;
	return 301 https://acc.healthstat.be$request_uri;
        }
    }

    server {
        listen        *:9089;
        server_name acc-v3.healthstat.be;
        rewrite ^/(.*)$ https://acc.healthstat.be/$1 permanent;

        error_page    500 502 503 504  /50x.html;
        # include includes/https_generic_proxyssl_client.conf;
        location / {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $host;
        proxy_pass https://lb_https_upstream;
        }
    }

# server {
#         listen        *:80;
# server_name tst-v3.healthstat.be dev.healthstat.be;
# location /
# {
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header Host $host;
#         proxy_pass http://10.72.131.3;
# }
# }
    
    upstream openresty_consul_service_mesh_prod
    {
    server 10.72.131.3:8080;
    }

        upstream openresty_consul_service_mesh_acc
    {
    server 10.72.131.2:8080;
    }

    upstream openresty_consul_service_mesh_test
    {
    server 10.72.131.1:8080;
    }

    server {
        listen        *:80;
        server_name api.healthstat.be ops.healthstat.be;
        # monitor-tst.healthstat.be monitor.healthstat.be is now moved to openresty
        error_page    500 502 503 504  /50x.html;
        # include includes/https_generic_proxyssl_client.conf;
        location / {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $host;
        # proxy_pass https://lb_https_upstream;
        proxy_pass http://openresty_consul_service_mesh_prod;
        }
    }

    server {
        listen        *:80;
        server_name api-acc.healthstat.be ops-acc.healthstat.be;
        # monitor-tst.healthstat.be monitor.healthstat.be is now moved to openresty
        error_page    500 502 503 504  /50x.html;
        # include includes/https_generic_proxyssl_client.conf;
        location / {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $host;
        # proxy_pass https://lb_https_upstream;
        proxy_pass http://openresty_consul_service_mesh_acc;
        }
    }

        server {
        listen        *:80;
        server_name api-tst.healthstat.be ops-tst.healthstat.be;
        # monitor-tst.healthstat.be monitor.healthstat.be is now moved to openresty
        error_page    500 502 503 504  /50x.html;
        # include includes/https_generic_proxyssl_client.conf;
        location / {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $host;
        # proxy_pass https://lb_https_upstream;
        proxy_pass http://openresty_consul_service_mesh_test;
        }
    }

    server {
        listen        *:80;
        server_name disable_acc.healthstat.be;
        # monitor-tst.healthstat.be monitor.healthstat.be is now moved to openresty
        error_page    500 502 503 504  /50x.html;
        # include includes/https_generic_proxyssl_client.conf;
        location / {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $host;
        # proxy_pass https://lb_https_upstream;
        proxy_pass http://azure_acc_lb_http_upstream;
        }
    }


    # server {
    #     listen        *:80;
    #     server_name v3-tst.healthstat.be tst.healthstat.be acc.healthstat.be sso-dev.healthstat.be sso-tst.healthstat.be api.healthstat.be api-acc.healthstat.be api-dev.healthstat.be  api-tst.healthstat.be ops.healthstat.be ops-acc.healthstat.be ops-dev.healthstat.be ops-tst.healthstat.be monitor-acc.healthstat.be monitor-dev.healthstat.be;
    #     # monitor-tst.healthstat.be monitor.healthstat.be is now moved to openresty
    #     error_page    500 502 503 504  /50x.html;
    #     # include includes/https_generic_proxyssl_client.conf;
    #     location / {
    #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #     proxy_set_header X-Real-IP $remote_addr;
    #     proxy_set_header Host $host;
    #     # proxy_pass https://lb_https_upstream;
    #     proxy_pass https://azure_acc_lb_https_upstream;
    #     }
    # }

    # Netscaler Arxus Healthstat v3 config production release on 28th June 2023
#         server {
#         listen      *:80;
#         server_name www.healthstat.be;
# 	# location / {
#     #             access_log /var/log/nginx/access.log main;
#     #     error_log  /var/log/nginx/error.log;
#     #     access_log  on;
#     #     error_log on;

#     # return 301 https://v3.healthstat.be;
#     # }
# }

    server {
        listen      *:80;
        server_name disabled_www.healthstat.be;
        access_log /var/log/nginx/access.log main;
        error_log  /var/log/nginx/error.log;
        access_log  on;
        error_log on;

        error_page    500 502 503 504  /50x.html;
        location /admin/
        {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host www.healthstat.be;
        proxy_pass http://azure_lb_http_upstream;
        proxy_connect_timeout 10m;
        proxy_send_timeout 10m;
        proxy_read_timeout 10m;
        send_timeout 10m;
        }

        location / {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host www.healthstat.be;
        proxy_pass http://10.72.131.6:3030;
        }

        location /zzz {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host www.healthstat.be;
        proxy_pass http://azure_lb_http_upstream;
        }
    }

    server {
        listen        *:80;
        server_name sso.healthstat.be;

        error_page    500 502 503 504  /50x.html;
        location /admin/
        {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $host;
        proxy_pass http://azure_lb_http_upstream;
        proxy_connect_timeout 10m;
        proxy_send_timeout 10m;
        proxy_read_timeout 10m;
        send_timeout 10m;
        }

        location / {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $host;
        proxy_pass http://azure_lb_http_upstream;
        }
    }

# Healthstat v3 domains END

#Netscaler-> Node 10.72.131.1:9080 then redirect to 10.72.131.2:9080 but me and Tim have changed ports to 80/443 to standardize the ports
#server {
#listen *:80;
#server s3.healthdata.be; #for future azure lb

#location /
#{
#proxy_pass 10.72.131.6;
#}

#}

# Healthstat v3 domains this is a temporary solution to get the v3 domains working (bypassing the LB) until the LB is fixed for Prod in Netscaler

    server {
        listen *:80;
        #        listen *:80;
        #        listen *:443 ssl;
        server_name sso.healthdata.be;
        error_page    500 502 503 504  /50x.html;
        # include includes/https_generic_proxyssl_client.conf;
        location /xxxxzzzzzz {
        default_type text/html;
        return 200 "HD SSO coming back soon";
        }

      location / {
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header Host $host;
              proxy_pass https://azurehsaks_lb_https_upstream;
              }
          }

    server {
        listen *:80;
        server_name sso-acc.healthdata.be;
        error_page    500 502 503 504  /50x.html;
        # include includes/https_generic_proxyssl_client.conf;
        location / {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $host;
        #proxy_pass https://10.72.131.14; # worker01 k3s in arxus for debugging ldap issue
        #proxy_pass https://azure_acc_lb_https_upstream;
        proxy_pass https://azure_acc_sso_lb_https_upstream;
        #proxy_pass https://lb_https_upstream;
        }
    }

    server {
        listen *:80;
        server_name sso-acc-2.healthdata.be;
        error_page    500 502 503 504  /50x.html;
        # include includes/https_generic_proxyssl_client.conf;
        location / {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $host;
        proxy_pass https://10.72.131.14; # worker01 k3s in arxus for debugging ldap issue
        #proxy_pass https://azure_acc_lb_https_upstream;
        #proxy_pass https://lb_https_upstream;
        }
    }

    server {
        listen *:80;
        #        listen *:80;
        #        listen *:443 ssl;
        server_name sso-dev.healthdata.be;
        # zzzsso-acc.healthdata.be zzzsso.healthdata.be
        error_page    500 502 503 504  /50x.html;
        # include includes/https_generic_proxyssl_client.conf;
        location / {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $host;
        proxy_pass https://azure_acc_lb_https_upstream;
        }
    }

    server {
        listen *:80;
        #        listen *:80;
        #        listen *:443 ssl;
        server_name sso-test.healthdata.be;
        # zzzsso-acc.healthdata.be zzzsso.healthdata.be
        error_page    500 502 503 504  /50x.html;
        # include includes/https_generic_proxyssl_client.conf;
        location / {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $host;
        proxy_pass https://azure_test_sso_lb_https_upstream;
        }
    }
